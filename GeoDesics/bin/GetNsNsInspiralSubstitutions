undef &RunInDirectory;
*RunInDirectory = \&CaptureSubstitutions;
undef &CreateSubmitScript;
*CreateSubmitScript = \&DoNothing;

sub DoNothing { }

sub CaptureSubstitutions {
    my($dir,$replacements,$supplied_options) = @_;

    # Sanity check
    if(@_<2 or @_>3) {
        die "RunInDirectory takes 2-3 arguments. You gave it "
            . scalar(@_) . ".\n";
    }

    my %InspiralSubstitutions;
    foreach my $file (keys %$replacements) {
      foreach my $subst (keys %{$replacements->{$file}}) {
        if(not exists $InspiralSubstitutions{$subst}) {
          $InspiralSubstitutions{$subst} = $replacements->{$file}->{$subst};
        } else {
          die "Inconsistent replacements for $subst" unless $replacements->{$file}->{$subst} eq $InspiralSubstitutions{$subst};
        }
      }
    }

    foreach my $subst (sort keys %InspiralSubstitutions) {
      $subst =~ m/__(.*)__/;
      print FH "\$$1 = q($InspiralSubstitutions{$subst});\n";
    }
}

open FH,">InspiralSubstitutions.perl";
my $pwd=`/bin/pwd`; chomp $pwd;
chdir("..") || die "Cannot cd ..";
EvalPerlCodeInFile("DoMultipleRuns.input");
chdir($pwd) || die "Cannot cd $pwd";
close FH;
