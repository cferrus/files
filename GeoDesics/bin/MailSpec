#!/usr/bin/env python

"""Send an email message.

This utility serves as a replacement for the mail utility in cases where it
is not available. It will send mail using a SpEC system instead of relying
on the local system for mail delivery.

CONFIGURATION

This script sends mail through black-holes.org, with authentication based on
source IP address. To enable usage of this script on a new machine, add its
IP address or network to "mynetworks" in /etc/postfix/main.cf on
black-holes.org and restart postfix.
"""

import getpass
import smtplib
import socket
import sys

from email.mime.text import MIMEText
from optparse import OptionParser

def sendmail(from_, to, body, subject=None):
    """Routine to send email message."""
    msg = MIMEText(body)

    # Set message headers
    msg['From'] = from_
    msg['To'] = " ".join(to)
    if subject is not None:
        msg['Subject'] = subject

    # Now send the message, through black-holes.org
    s = smtplib.SMTP('black-holes.org')
    try:
        s.sendmail(from_, to, msg.as_string())
    except smtplib.SMTPException as e:
        print "Got an SMTP error:", e
        print "Perhaps you need to configure black-holes.org for this machine?"
        print "(See comment CONFIGURATION in MailSpec script source.)";
    finally:
        s.quit()

def main():
    """Main routine, run when called from command line."""
    "usage: %prog [options] arg1 arg2"
    parser = OptionParser(usage="usage: %prog [-s SUBJECT] toaddr [toaddr..]")

    parser.add_option("-s", "--subject", dest="subject",
                  help="subject to use for message")

    (options, args) = parser.parse_args()

    if not args:
        print "A destination address is required!"
        parser.print_help()
        sys.exit(1)

    # Use the "default" from address
    fromaddr = getpass.getuser()+"@"+socket.getfqdn()

    # Send the message
    sendmail(fromaddr, args, sys.stdin.read(), options.subject)

if __name__ == "__main__":
    main()
